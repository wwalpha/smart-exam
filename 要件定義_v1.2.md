# 学習教材・復習テスト管理システム 要件定義書（統合版 v1.2）

## 0. 目的

- SAPIX / 四谷大塚の教材（問題・解答・答案）を一元管理する
- 問題番号・漢字単位で正誤・履歴を蓄積する
- 復習テストを生成し、復習効率を最大化する（不正解中心＋未実施も対象）
- 問題番号は教材差・表記差を吸収し、階層構造として統一管理する
- 教材ファイルは削除しない

## 1. 対象教材

### 1.1 SAPIX

- 採点済み答案用紙（画像 / PDF）
- 問題用紙（画像 / PDF）
- 解答（画像 / PDF）

### 1.2 四谷大塚

- 問題用紙（画像 / PDF）
- 解答（画像 / PDF）

## 2. 用語定義

- 教材セット（MaterialSet）：
  同一テスト回に属する「問題用紙・解答・（SAPIXの場合）答案」の集合
- 問題番号（Question Identifier）：
  教材内の設問を一意に識別する階層番号（例：1-1-1, 1-2-A）
- canonicalKey：
  表記ゆれを吸収したDB登録用の統一表現（DBキーとして使用）
- displayLabel：
  人間が読むための表示用問題番号（例：1(2)ア）
- 復習テスト（Exam）：
  問題または漢字を集めて実施する単位。生成ごとに TestID を持つ
- dueDate：
  「テストすべき日」。テスト生成の選択順に使用

---

## 3. 問題番号の統一ルール（最重要）

### 3.1 基本方針

- 問題番号は階層構造として管理する
- displayLabel（表示）と canonicalKey（保存キー）を分離する
- DBでは canonicalKey を唯一のキーとして扱う（検索・履歴・生成に使用）

### 3.2 構造定義（最大4階層）

<大問>-<中問>-<小問>-<枝番>

例：
1
1-1
1-1-1
1-2-A
2-3-2-B

### 3.3 各階層のルール

- 第1階層（大問）：数字
- 第2階層（中問）：数字
- 第3階層（小問）：数字 or 英大文字
- 第4階層（枝番）：数字 or 英大文字
- 英字は必ず大文字
- 区切りは「-」で統一

### 3.4 正規化ルール（canonicalKey生成）

同一扱いの例：
1(1)(1), １−１−１, 1－1－1, 1_1_1 → 1-1-1
1-2-a → 1-2-A

正規化処理：

- 全角→半角
- 記号（( ) ／ － \_ .）→ -
- 英字→大文字
- 連続ハイフンは1つにまとめる

### 3.5 内部表現（例）

- displayLabel: "1(2)ア"
- canonicalKey: "1-2-A"
- level1: 1 / level2: 2 / level3: "A" / level4: null

---

## 4. 教材管理（登録・検索・保管）

### 4.1 教材セット登録

- 教材セットの登録・編集（削除は提供しない。必要であれば「参照不可（アーカイブ）」等で運用する）
- 必須メタデータ：
  - 教材名（例：週テスト、組分けテスト、練習問題 等）
  - 実施日
  - 科目（算数 / 国語 / 理科 / 社会）
- 任意メタデータ：
  - 学年
  - 回・テスト名
  - 教材種別（SAPIX / 四谷大塚）
  - 単元名
  - 教室 / コース / クラス
  - メモ
  - 追加キーワード（検索用）：複数

### 4.2 教材ファイル管理

- PDF / JPG / PNG を登録できる
- ページ単位のプレビュー（ページ番号の紐付けは不要）
- 教材ファイルは物理削除しない（常に保持）

### 4.3 教材検索

- 教材セット一覧は以下で検索・絞り込みできる：
  - 科目、学年、教材名、実施日（期間）、回・テスト名、単元、コース/クラス、追加キーワード

---

## 5. 問題・漢字の登録（スキャン/手動）と編集

### 5.1 問題登録（教材内問題の作成）

- 教材セットに対して問題（canonicalKey/displayLabel）を登録できる
- スキャン/OCR等による「問題番号候補の自動生成」をサポートする
  - SAPIX：答案用紙から「回答された問題番号候補」を抽出
  - 四谷大塚：解答から「問題番号候補」を抽出
  - いずれも自動生成は候補提示であり、手動確定が必須

### 5.2 問題番号候補の編集（確定前・確定後）

- 自動生成した候補は手動で修正できる：
  - displayLabel修正
  - canonicalKey修正（正規化ルールに従う）
  - 候補の追加・削除
- スキャン登録時に過不足があれば手動で追加/削除できる
- 追加/削除・修正の操作ログは保持する

### 5.3 漢字登録

- 漢字マスタ（漢字、よみ、意味、科目（国語/社会）、出典/メモ（任意））を登録できる

### 5.4 漢字大量登録（.txt インポート）

- 形式：1行=1漢字、区切りは「|」
  例：漢字|よみ|意味
- 必須：漢字
- 任意：よみ、意味
- 重複時の挙動：スキップ or 更新を選択可能
- インポート検証レポートを表示：
  - 成功件数、重複件数（スキップ/更新内訳）、エラー件数
  - エラー行（行番号・内容・理由）

### 5.5 データ構造（要点）

- 問題（Question）は以下の属性を持つ：
  - materialSetId（元教材セットID）
  - canonicalKey（DBキー）
  - displayLabel（表示用）
  - 科目
  - 分野/単元等の分類（任意）
- 履歴（Attempt / KanjiAttempt）は「上書き」ではなく「追加」で保持する：
  - state（未実施/正解/不正解）、実施日、メモ（任意）
  - streak（直近の連続正解回数。問題/漢字ともに 3 で永久除外）
- 復習テスト（Exam）は生成単位として TestID を持ち、status を持つ：
  - IN_PROGRESS / COMPLETED / PAUSED / CANCELED
- 復習テスト項目（ExamItem）は「テストに含めた対象」を表す：
  - testId、targetType（QUESTION/KANJI）、targetId
- ロックは内部的に「targetId → testId」の紐付けとして保持し、多重ロックは禁止する

---

## 6. 状態・履歴（Attempt）

### 6.1 状態（State）

- 問題・漢字は共通で 3 state：
  - 未実施 / 正解 / 不正解
- 最新が現在状態。過去履歴は全保持。

### 6.2 履歴（Attempt / KanjiAttempt）

- 登録項目：
  - state（未実施/正解/不正解）
  - 実施日（手動指定可、デフォルト当日）
  - メモ（任意）
- 連続正解回数（streak）を保持：
  - 問題：3連続正解で永久除外
  - 漢字：3連続正解で永久除外
  - 不正解が入ったら streak を 0 にリセット

---

## 7. 復習スケジュール（dueDate算出）と永久除外

### 7.1 漢字のスケジュール

- 初回登録：登録日 + 7日
- 正解1回：最終正解日 + 30日
- 連続正解2回：最終正解日 + 90日
- 3連続正解：今後テスト対象外（永久除外）
- 不正解：最終不正解日 + 1日

### 7.2 問題のスケジュール

- 不正解：最終不正解日 + 30日
- 正解：最終正解日 + 90日
- 連続正解：最終正解日 + 90日（正解と同じ）
- 3連続正解：今後テスト対象外（永久除外）

### 7.3 未実施の扱い

- 未実施もテスト生成対象に含める
- 未実施の dueDate は「登録日」を基準に算出する（7.4 の固定ルールに従う）

### 7.4 dueDate 算出の固定ルール

- dueDate は日付（YYYY-MM-DD）単位で扱う（時刻は要件上の比較に使用しない）
- 「最終実施日」は以下の優先順で定義する：
  - Attempt/KanjiAttempt が存在する場合：最新 attemptDate
  - 存在しない場合：登録日
- 問題（Question）の dueDate：
  - 3連続正解：永久除外（dueDate を持たない/対象外）
  - 最新 state が不正解：最終不正解日 + 30日
  - 最新 state が正解：最終正解日 + 90日
  - 履歴なし（未実施のみ）：登録日（登録日 + 0日）
- 漢字（Kanji）の dueDate：
  - 3連続正解：永久除外（dueDate を持たない/対象外）
  - 最新 state が不正解：最終不正解日 + 1日
  - 最新 state が正解：streak=1 のとき最終正解日 + 30日、streak=2 のとき最終正解日 + 90日
  - 履歴なし（未実施のみ）：登録日 + 7日

---

## 8. 復習テスト（生成・排他制御・入力・削除）

### 8.1 テスト生成（共通）

- テスト作成時に指定できる：
  - 科目
  - 出題数（問題数 or 漢字数）-（任意）対象期間：直近N日 / 全期間（最終実施日でフィルタする）
- 問題登録と初回テスト生成は分離（自動生成しない）
- 対象不足でも、可能な分だけでテストを生成する
  - 生成結果が件数未満の場合：ユーザーが運用で「実施」または「テスト削除」を判断する
  - 画面には「指定件数」「生成件数」「不足数（指定-生成）」を必ず表示する
  - 不足理由の詳細（ロック中等の内訳表示）は不要

### 8.2 テスト詳細表示（参照情報）

- テスト詳細では、各出題項目（問題/漢字）に対して以下を表示できる：
  - 問題：displayLabel / canonicalKey
  - 元教材セットのメタデータ（教材名、実施日、回・テスト名、学年、教材種別 等）
- テスト詳細から元教材セット（および登録済み教材ファイル）へ遷移できる導線を提供する

### 8.3 テスト生成の選択順（固定ルール）

- 各対象（問題/漢字）は dueDate を持つ
- 選択順は以下で決定する（決定論）：
  1. dueDate が最も古い（今日から最も離れている＝遅延が最大）ものを優先
  2. 同一 dueDate の場合、最終実施日が古いものを優先
  3. それでも同率なら ID 昇順等で固定

### 8.4 排他制御（ロック）

- テスト生成時、採用された対象（問題/漢字）をロックする
- 1対象は同時に1テストにのみ属する（多重ロック禁止）
- ロックのユーザー向け可視化は不要（内部保持のみ）

### 8.5 ロック解除（自動解除なし）

- ロックは自動解除しない
- ロック解除は以下のみ：
  - 当該テストで対象に対し state が「正解」または「不正解」として登録された時点
  - テストが CANCELED または 削除された時点
- 手動ロック解除機能は提供しない（将来拡張）

### 8.6 テストのライフサイクル

- status：
  - IN_PROGRESS / COMPLETED / PAUSED / CANCELED
- テストは削除できる
  - 削除時：テストに紐づくロックは全解除され、対象は再利用可能
  - 教材ファイルは削除しない（保持）
  - 削除の実装は物理削除/論理削除のいずれでもよいが、「ロック解除」は必ず実行される

### 8.7 テスト結果入力UI（高速化）

- 手動入力を前提に、以下を提供：
  - 全問「正解」一括セット
  - 不正解だけチェックして一括で「不正解」へ変更（チェック式）
- テスト結果入力は履歴追加として扱い、入力のたびに Attempt/KanjiAttempt を追加する
- 実施日はデフォルト当日とし、任意に変更できる

---

## 9. 印刷・PDF出力

### 9.1 漢字テストPDF（印刷）

- 漢字テストはPDFを生成できる：
  1. 問題用PDF
  2. 解答用PDF（答え付き：解答を表示する）
- フロー：PDFプレビュー → 印刷（ブラウザ印刷）
- PDFに含める：TestID、作成日、科目、出題数、教材名等

### 9.2 漢字PDFテンプレ設定

- ユーザー単位でテンプレ設定を保持できる：
  - 用紙サイズ、余白、行数/列数、マス目サイズ、フォントサイズ
  - タイトルON/OFF、ヘッダ項目（TestID/作成日/科目/教材名 等）

### 9.3 問題テストのプリント出力（本文は生成しない）

- 問題テストは「問題一覧プリント（参照用）」をPDFで生成できる
- 本文は含めず、以下を出力：
  - TestID、作成日、科目、教材名
  - 問題番号一覧（displayLabel/canonicalKey）
  - 元教材セット情報（教材名、実施日、回・テスト名、学年、教材種別 等）
- フロー：PDFプレビュー → 印刷

---

## 10. 教材検索（問題番号から探す）

### 10.1 問題番号検索

- 入力：科目、問題番号（displayLabel または canonicalKey）
- 出力：該当する教材セット候補一覧：
  - 教材種別、教材名、実施日、回・テスト名、学年
  - 該当問題番号（displayLabel/canonicalKey）

### 10.2 テストから教材を探す導線

- テスト詳細の各問題行に「教材を探す」導線を提供
- 問題番号だけでなく、紐づく教材メタデータでも候補を絞り込める

---

## 11. 可視化（ダッシュボード）

### 11.1 ダッシュボード

- 最低限表示：
  - 本日実施予定のテスト数（定義：本日作成された IN_PROGRESS の復習テスト数）
  - 不正解率が高い上位問題・漢字（未実施は分母に含めない）
- 不正解率：
  - 不正解率 = 不正解回数 /（正解回数 + 不正解回数）

- （追加表示：v1.1 由来、任意）
  - ロック中の問題数・漢字数
  - テスト生成可能な在庫数（問題 / 漢字）

---

## 12. 非機能要件

- ファイルはユーザー単位でアクセス制御
- 問題番号抽出は非同期処理
- 操作ログ（登録・確定・追加削除・テスト生成・テスト削除）を保持
- バックアップ機能はユーザー提供しない（内部運用は実装側判断）

---

## 13. 実装フェーズ（案）

- Phase 1：
  教材管理（メタデータ/検索含む）、問題・漢字登録、状態入力、復習テスト生成、ロック、削除、問題一覧プリント
- Phase 2：
  問題番号の自動生成（SAPIX答案/四谷大塚解答）＋編集確定UI
- Phase 3：
  漢字PDF（テンプレ含む）、ダッシュボード拡充
