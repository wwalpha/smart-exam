openapi: 3.0.3
info:
  title: smart-exam Backend API
  version: "0.1.0"
  description: |
    OpenAPI spec generated from the current API list.
    Auth is assumed to be OIDC access token (Bearer JWT).

servers:
  - url: /
    description: Same-origin

security:
  - bearerAuth: []

tags:
  - name: Common
  - name: Auth
  - name: MaterialSets
  - name: Files
  - name: Questions
  - name: Kanji
  - name: Attempts
  - name: ReviewTests

paths:
  /api/health:
    get:
      tags: [Common]
      summary: Health check
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
              examples:
                ok:
                  value: { ok: true }

  /api/me:
    get:
      tags: [Auth]
      summary: Get current user profile
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/exampapers:
    get:
      tags: [ExamPapers]
      summary: List exam papers
      responses:
        "200":
          description: List of exam papers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExamPaperListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      tags: [ExamPapers]
      summary: Create an exam paper
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExamPaperCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExamPaperResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/examresults:
    get:
      tags: [ExamResults]
      summary: List exam results
      responses:
        "200":
          description: List of exam results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExamResultListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      tags: [ExamResults]
      summary: Create an exam result
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExamResultCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExamResultResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/exam/{testId}/attempts:
    post:
      tags: [Attempts]
      summary: Create a test attempt
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TestAttemptCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TestAttempt"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/attempts/{attemptId}/submit:
    patch:
      tags: [Attempts]
      summary: Submit a test attempt
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TestAttemptSubmitRequest"
      responses:
        "200":
          description: Submitted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TestAttempt"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/exam/{testId}/attempts/latest:
    get:
      tags: [Attempts]
      summary: Get latest attempt for a test
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Latest attempt
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TestAttempt"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/material-sets:
    get:
      tags: [MaterialSets]
      summary: List material sets
      parameters:
        - $ref: "#/components/parameters/SubjectQuery"
        - $ref: "#/components/parameters/GradeQuery"
        - $ref: "#/components/parameters/ProviderQuery"
        - $ref: "#/components/parameters/FromDateQuery"
        - $ref: "#/components/parameters/ToDateQuery"
        - $ref: "#/components/parameters/QQuery"
        - $ref: "#/components/parameters/LimitQuery"
        - $ref: "#/components/parameters/CursorQuery"
      responses:
        "200":
          description: List result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaterialSetListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      tags: [MaterialSets]
      summary: Create a material set
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaterialSetCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaterialSetResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/material-sets/{materialSetId}:
    get:
      tags: [MaterialSets]
      summary: Get material set detail
      parameters:
        - $ref: "#/components/parameters/MaterialSetIdPath"
      responses:
        "200":
          description: Detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaterialSetResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags: [MaterialSets]
      summary: Update material set metadata
      parameters:
        - $ref: "#/components/parameters/MaterialSetIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaterialSetPatchRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaterialSetResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/material-sets/{materialSetId}/files:
    get:
      tags: [Files]
      summary: List files for a material set
      parameters:
        - $ref: "#/components/parameters/MaterialSetIdPath"
      responses:
        "200":
          description: File list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaterialFileListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    post:
      tags: [Files]
      summary: Upload a file (PDF/JPG/PNG) to a material set
      parameters:
        - $ref: "#/components/parameters/MaterialSetIdPath"
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "201":
          description: Uploaded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaterialFileResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "413":
          $ref: "#/components/responses/PayloadTooLarge"

  /api/files/{fileId}/download:
    get:
      tags: [Files]
      summary: Download a file (signed URL or stream)
      parameters:
        - $ref: "#/components/parameters/FileIdPath"
      responses:
        "200":
          description: Signed URL or file stream
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileDownloadResponse"
              examples:
                signedUrl:
                  value: { url: "https://example.com/signed-url", expiresAt: "2026-01-03T00:00:00Z" }
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/files/{fileId}:
    patch:
      tags: [Files]
      summary: Update file status (e.g., archive)
      parameters:
        - $ref: "#/components/parameters/FileIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaterialFilePatchRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaterialFileResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/material-sets/{materialSetId}/questions/candidates:
    post:
      tags: [Questions]
      summary: Register question candidates (e.g., OCR suggestions)
      parameters:
        - $ref: "#/components/parameters/MaterialSetIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuestionCandidatesRequest"
      responses:
        "200":
          description: Candidates accepted (as suggestions)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuestionCandidatesResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/material-sets/{materialSetId}/questions:
    get:
      tags: [Questions]
      summary: List questions for a material set
      parameters:
        - $ref: "#/components/parameters/MaterialSetIdPath"
      responses:
        "200":
          description: Question list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuestionListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    post:
      tags: [Questions]
      summary: Create/confirm questions for a material set
      parameters:
        - $ref: "#/components/parameters/MaterialSetIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuestionCreateRequest"
      responses:
        "201":
          description: Created/confirmed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuestionListResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"

  /api/questions/{questionId}:
    patch:
      tags: [Questions]
      summary: Update question metadata (label/key/tags)
      parameters:
        - $ref: "#/components/parameters/QuestionIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuestionPatchRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuestionResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"

  /api/kanji:
    get:
      tags: [Kanji]
      summary: List kanji
      parameters:
        - $ref: "#/components/parameters/QQuery"
        - $ref: "#/components/parameters/LimitQuery"
        - $ref: "#/components/parameters/CursorQuery"
      responses:
        "200":
          description: Kanji list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KanjiListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      tags: [Kanji]
      summary: Create a kanji entry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/KanjiCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KanjiResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/Conflict"

  /api/kanji/import:
    post:
      tags: [Kanji]
      summary: Bulk import kanji from text
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/KanjiImportRequest"
      responses:
        "200":
          description: Import report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KanjiImportResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/questions/{questionId}/attempts:
    post:
      tags: [Attempts]
      summary: Add an attempt for a question (append-only)
      parameters:
        - $ref: "#/components/parameters/QuestionIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AttemptCreateRequest"
      responses:
        "201":
          description: Attempt recorded and derived status returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttemptWithDerivedResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/questions/{questionId}/status:
    get:
      tags: [Attempts]
      summary: Get derived status for a question
      parameters:
        - $ref: "#/components/parameters/QuestionIdPath"
      responses:
        "200":
          description: Derived status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DerivedStatusResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/kanji/{kanjiId}/attempts:
    post:
      tags: [Attempts]
      summary: Add an attempt for a kanji (append-only)
      parameters:
        - $ref: "#/components/parameters/KanjiIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AttemptCreateRequest"
      responses:
        "201":
          description: Attempt recorded and derived status returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttemptWithDerivedResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/kanji/{kanjiId}/status:
    get:
      tags: [Attempts]
      summary: Get derived status for a kanji
      parameters:
        - $ref: "#/components/parameters/KanjiIdPath"
      responses:
        "200":
          description: Derived status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DerivedStatusResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/review-tests:
    get:
      tags: [ReviewTests]
      summary: List review tests
      parameters:
        - name: status
          in: query
          schema:
            $ref: "#/components/schemas/ReviewTestStatus"
        - $ref: "#/components/parameters/SubjectQuery"
        - $ref: "#/components/parameters/LimitQuery"
        - $ref: "#/components/parameters/CursorQuery"
      responses:
        "200":
          description: Review test list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReviewTestListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      tags: [ReviewTests]
      summary: Generate a new review test (deterministic selection + locks)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReviewTestCreateRequest"
      responses:
        "201":
          description: Generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReviewTestCreateResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/Conflict"

  /api/review-tests/{testId}:
    get:
      tags: [ReviewTests]
      summary: Get review test detail (items + referenced metadata)
      parameters:
        - $ref: "#/components/parameters/TestIdPath"
      responses:
        "200":
          description: Detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReviewTestDetailResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags: [ReviewTests]
      summary: Update review test status
      parameters:
        - $ref: "#/components/parameters/TestIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReviewTestPatchRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReviewTestResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"

    delete:
      tags: [ReviewTests]
      summary: Delete a review test (must release locks)
      parameters:
        - $ref: "#/components/parameters/TestIdPath"
      responses:
        "204":
          description: Deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/review-tests/{testId}/results:
    post:
      tags: [ReviewTests]
      summary: Submit results for a review test (bulk entry; unlock targets)
      parameters:
        - $ref: "#/components/parameters/TestIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReviewTestResultsRequest"
      responses:
        "200":
          description: Results applied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReviewTestResultsResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    LimitQuery:
      name: limit
      in: query
      description: Page size (default 50, max 200)
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
    CursorQuery:
      name: cursor
      in: query
      description: Opaque cursor
      schema:
        type: string
    QQuery:
      name: q
      in: query
      description: Free-text search
      schema:
        type: string
    SubjectQuery:
      name: subject
      in: query
      schema:
        $ref: "#/components/schemas/Subject"
    GradeQuery:
      name: grade
      in: query
      schema:
        type: string
    ProviderQuery:
      name: provider
      in: query
      schema:
        $ref: "#/components/schemas/Provider"
    FromDateQuery:
      name: from
      in: query
      description: Start date (YYYY-MM-DD)
      schema:
        type: string
        format: date
    ToDateQuery:
      name: to
      in: query
      description: End date (YYYY-MM-DD)
      schema:
        type: string
        format: date

    MaterialSetIdPath:
      name: materialSetId
      in: path
      required: true
      schema:
        type: string
    FileIdPath:
      name: fileId
      in: path
      required: true
      schema:
        type: string
    QuestionIdPath:
      name: questionId
      in: path
      required: true
      schema:
        type: string
    KanjiIdPath:
      name: kanjiId
      in: path
      required: true
      schema:
        type: string
    TestIdPath:
      name: testId
      in: path
      required: true
      schema:
        type: string

  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    PayloadTooLarge:
      description: Payload too large
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    # --- Minimal enums ---
    Subject:
      type: string
      enum: [MATH, JAPANESE, SCIENCE, SOCIAL]
    Provider:
      type: string
      enum: [SAPIX, YOTSUYA, OTHER]
    ReviewTestStatus:
      type: string
      enum: [IN_PROGRESS, COMPLETED, PAUSED, CANCELED]
    TargetType:
      type: string
      enum: [QUESTION, KANJI]
    AttemptState:
      type: string
      enum: [CORRECT, WRONG]

    # --- Common response helpers ---
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code: { type: string }
            message: { type: string }
            details: { type: object, additionalProperties: true }
            requestId: { type: string }

    PageMeta:
      type: object
      properties:
        nextCursor: { type: string, nullable: true }

    # --- Auth ---
    MeResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            sub: { type: string }
            name: { type: string, nullable: true }

    # --- MaterialSets ---
    MaterialSet:
      type: object
      required: [id, title, examDate, subject, keywords, createdAt, updatedAt]
      properties:
        id: { type: string }
        title: { type: string }
        examDate: { type: string, format: date }
        subject: { $ref: "#/components/schemas/Subject" }
        grade: { type: string, nullable: true }
        roundName: { type: string, nullable: true }
        provider: { $ref: "#/components/schemas/Provider", nullable: true }
        unitName: { type: string, nullable: true }
        className: { type: string, nullable: true }
        memo: { type: string, nullable: true }
        keywords:
          type: array
          items: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    MaterialSetCreateRequest:
      type: object
      required: [title, examDate, subject]
      properties:
        title: { type: string }
        examDate: { type: string, format: date }
        subject: { $ref: "#/components/schemas/Subject" }
        grade: { type: string, nullable: true }
        roundName: { type: string, nullable: true }
        provider: { $ref: "#/components/schemas/Provider", nullable: true }
        unitName: { type: string, nullable: true }
        className: { type: string, nullable: true }
        memo: { type: string, nullable: true }
        keywords:
          type: array
          items: { type: string }
          default: []

    MaterialSetPatchRequest:
      type: object
      properties:
        title: { type: string }
        examDate: { type: string, format: date }
        subject: { $ref: "#/components/schemas/Subject" }
        grade: { type: string, nullable: true }
        roundName: { type: string, nullable: true }
        provider: { $ref: "#/components/schemas/Provider", nullable: true }
        unitName: { type: string, nullable: true }
        className: { type: string, nullable: true }
        memo: { type: string, nullable: true }
        keywords:
          type: array
          items: { type: string }

    MaterialSetResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/MaterialSet"

    MaterialSetListResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/MaterialSet" }
            nextCursor: { type: string, nullable: true }

    # --- Files ---
    MaterialFile:
      type: object
      required: [id, materialSetId, fileName, contentType, sizeBytes, storageKey, status, createdAt]
      properties:
        id: { type: string }
        materialSetId: { type: string }
        fileName: { type: string }
        contentType:
          type: string
          enum: [application/pdf, image/jpeg, image/png]
        sizeBytes: { type: integer, minimum: 0 }
        storageKey: { type: string }
        status:
          type: string
          enum: [ACTIVE, ARCHIVED]
        createdAt: { type: string, format: date-time }

    MaterialFileResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            file: { $ref: "#/components/schemas/MaterialFile" }

    MaterialFileListResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/MaterialFile" }
            nextCursor: { type: string, nullable: true }

    MaterialFilePatchRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [ACTIVE, ARCHIVED]

    FileDownloadResponse:
      type: object
      properties:
        url: { type: string, format: uri, nullable: true }
        expiresAt: { type: string, format: date-time, nullable: true }

    # --- Questions ---
    Question:
      type: object
      required: [id, materialSetId, subject, displayLabel, canonicalKey, createdAt, updatedAt]
      properties:
        id: { type: string }
        materialSetId: { type: string }
        subject: { $ref: "#/components/schemas/Subject" }
        displayLabel: { type: string }
        canonicalKey: { type: string }
        tags:
          type: array
          items: { type: string }
          nullable: true
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    QuestionCandidatesRequest:
      type: object
      required: [source, candidates]
      properties:
        source:
          type: string
          enum: [ANSWER_SHEET, SOLUTION, MANUAL]
        candidates:
          type: array
          items:
            type: object
            required: [displayLabel, canonicalKey]
            properties:
              displayLabel: { type: string }
              canonicalKey: { type: string }

    QuestionCandidatesResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            candidates:
              type: array
              items:
                type: object
                properties:
                  tempId: { type: string }
                  displayLabel: { type: string }
                  canonicalKey: { type: string }
                  normalizedCanonicalKey: { type: string }

    QuestionCreateRequest:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            type: object
            required: [displayLabel, canonicalKey, subject]
            properties:
              displayLabel: { type: string }
              canonicalKey: { type: string }
              subject: { $ref: "#/components/schemas/Subject" }
              tags:
                type: array
                items: { type: string }

    QuestionPatchRequest:
      type: object
      properties:
        displayLabel: { type: string }
        canonicalKey: { type: string }
        tags:
          type: array
          items: { type: string }

    QuestionResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/Question"

    QuestionListResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/Question" }
            nextCursor: { type: string, nullable: true }

    # --- Kanji ---
    Kanji:
      type: object
      required: [id, char, createdAt, updatedAt]
      properties:
        id: { type: string }
        char: { type: string }
        yomi: { type: string, nullable: true }
        meaning: { type: string, nullable: true }
        note: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    KanjiCreateRequest:
      type: object
      required: [char]
      properties:
        char: { type: string }
        yomi: { type: string, nullable: true }
        meaning: { type: string, nullable: true }
        note: { type: string, nullable: true }

    KanjiResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/Kanji"

    KanjiListResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/Kanji" }
            nextCursor: { type: string, nullable: true }

    KanjiImportRequest:
      type: object
      required: [mode, text]
      properties:
        mode:
          type: string
          enum: [SKIP, UPSERT]
        text:
          type: string
          description: "1 line = 1 record; format: 漢字|よみ|意味"

    KanjiImportResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            summary:
              type: object
              properties:
                success: { type: integer }
                duplicates: { type: integer }
                updated: { type: integer }
                skipped: { type: integer }
                errors: { type: integer }
            errors:
              type: array
              items:
                type: object
                properties:
                  line: { type: integer }
                  raw: { type: string }
                  reason: { type: string }

    # --- Attempts / derived status ---
    AttemptCreateRequest:
      type: object
      required: [state]
      properties:
        state: { $ref: "#/components/schemas/AttemptState" }
        attemptDate:
          type: string
          format: date
          nullable: true
        memo: { type: string, nullable: true }

    DerivedStatus:
      type: object
      properties:
        currentState:
          type: string
          enum: [UNTRIED, CORRECT, WRONG]
        streak: { type: integer, minimum: 0 }
        dueDate: { type: string, format: date, nullable: true }
        excluded: { type: boolean }
        lastAttemptDate: { type: string, format: date, nullable: true }

    DerivedStatusResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/DerivedStatus"

    AttemptWithDerivedResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            attempt:
              type: object
              description: Attempt record (append-only). Concrete shape is implementation-defined.
              additionalProperties: true
            derived:
              $ref: "#/components/schemas/DerivedStatus"

    # --- Review tests ---
    ReviewTest:
      type: object
      required: [id, subject, targetType, requestedCount, generatedCount, status, createdAt, updatedAt]
      properties:
        id: { type: string }
        subject: { $ref: "#/components/schemas/Subject" }
        targetType: { $ref: "#/components/schemas/TargetType" }
        requestedCount: { type: integer, minimum: 1 }
        generatedCount: { type: integer, minimum: 0 }
        status: { $ref: "#/components/schemas/ReviewTestStatus" }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    ReviewTestItem:
      type: object
      required: [id, testId, targetType, targetId, createdAt]
      properties:
        id: { type: string }
        testId: { type: string }
        targetType: { $ref: "#/components/schemas/TargetType" }
        targetId: { type: string }
        dueDate: { type: string, format: date, nullable: true }
        lastAttemptDate: { type: string, format: date, nullable: true }
        createdAt: { type: string, format: date-time }

    ReviewTestCreateRequest:
      type: object
      required: [subject, targetType, count]
      properties:
        subject: { $ref: "#/components/schemas/Subject" }
        targetType: { $ref: "#/components/schemas/TargetType" }
        count: { type: integer, minimum: 1, maximum: 200 }
        period:
          type: object
          nullable: true
          description: Optional filter window for selection.
          properties:
            type:
              type: string
              enum: [ALL, RECENT_DAYS]
            days:
              type: integer
              minimum: 1
              nullable: true

    ReviewTestCreateResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            test: { $ref: "#/components/schemas/ReviewTest" }
            items:
              type: array
              items: { $ref: "#/components/schemas/ReviewTestItem" }
            shortage:
              type: object
              properties:
                requested: { type: integer }
                generated: { type: integer }
                missing: { type: integer }

    ReviewTestResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/ReviewTest"

    ReviewTestListResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/ReviewTest" }
            nextCursor: { type: string, nullable: true }

    ReviewTestDetailResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            test: { $ref: "#/components/schemas/ReviewTest" }
            items:
              type: array
              items: { $ref: "#/components/schemas/ReviewTestItem" }
            referenced:
              type: object
              nullable: true
              description: Optional referenced metadata to render the test quickly.
              additionalProperties: true

    ReviewTestPatchRequest:
      type: object
      required: [status]
      properties:
        status: { $ref: "#/components/schemas/ReviewTestStatus" }

    ReviewTestResultsRequest:
      type: object
      description: |
        Bulk result entry. You may provide either:
        - mode=ALL_CORRECT + optional exceptions
        - mode=EXPLICIT_ITEMS with per-item states
      required: [mode]
      properties:
        mode:
          type: string
          enum: [ALL_CORRECT, EXPLICIT_ITEMS]
        wrongTargetIds:
          type: array
          items: { type: string }
          nullable: true
          description: Used when mode=ALL_CORRECT; mark these targets as WRONG.
        items:
          type: array
          nullable: true
          description: Used when mode=EXPLICIT_ITEMS
          items:
            type: object
            required: [targetType, targetId, state]
            properties:
              targetType: { $ref: "#/components/schemas/TargetType" }
              targetId: { type: string }
              state: { $ref: "#/components/schemas/AttemptState" }
              memo: { type: string, nullable: true }
              attemptDate: { type: string, format: date, nullable: true }

    ReviewTestResultsResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            appliedCount: { type: integer }
            unlockedCount: { type: integer }
            perItem:
              type: array
              items:
                type: object
                properties:
                  targetType: { $ref: "#/components/schemas/TargetType" }
                  targetId: { type: string }
                  state: { $ref: "#/components/schemas/AttemptState" }
                  derived:
                    $ref: "#/components/schemas/DerivedStatus"

    # --- Exam Papers ---
    ExamPaper:
      type: object
      required: [paperId, grade, subject, category, name, questionPdfKey, answerPdfKey, createdAt]
      properties:
        paperId: { type: string }
        grade: { type: string }
        subject: { type: string }
        category: { type: string }
        name: { type: string }
        questionPdfKey: { type: string }
        answerPdfKey: { type: string }
        createdAt: { type: string, format: date-time }

    ExamPaperCreateRequest:
      type: object
      required: [grade, subject, category, name, questionPdfKey, answerPdfKey]
      properties:
        grade: { type: string }
        subject: { type: string }
        category: { type: string }
        name: { type: string }
        questionPdfKey: { type: string }
        answerPdfKey: { type: string }

    ExamPaperResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/ExamPaper"

    ExamPaperListResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/ExamPaper" }
            nextCursor: { type: string, nullable: true }

    # --- Exam Results ---
    ExamResult:
      type: object
      required: [resultId, grade, subject, category, name, title, testDate, totalScore, details, createdAt]
      properties:
        resultId: { type: string }
        paperId: { type: string, nullable: true }
        grade: { type: string }
        subject: { type: string }
        category: { type: string }
        name: { type: string }
        title: { type: string }
        testDate: { type: string, format: date }
        totalScore: { type: number }
        details:
          type: array
          items:
            type: object
            required: [number, isCorrect]
            properties:
              number: { type: number }
              isCorrect: { type: boolean }
        gradedImagePath: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }

    ExamResultCreateRequest:
      type: object
      required: [grade, subject, category, name, title, testDate, totalScore, details]
      properties:
        paperId: { type: string, nullable: true }
        grade: { type: string }
        subject: { type: string }
        category: { type: string }
        name: { type: string }
        title: { type: string }
        testDate: { type: string, format: date }
        totalScore: { type: number }
        details:
          type: array
          items:
            type: object
            required: [number, isCorrect]
            properties:
              number: { type: number }
              isCorrect: { type: boolean }
        gradedImagePath: { type: string, nullable: true }

    ExamResultResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/ExamResult"

    ExamResultListResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/ExamResult" }
            nextCursor: { type: string, nullable: true }

    # --- Test Attempts ---
    TestAttempt:
      type: object
      required: [attemptId, testId, subjectId, status, startedAt, results]
      properties:
        attemptId: { type: string }
        testId: { type: string }
        subjectId: { type: string }
        status:
          type: string
          enum: [IN_PROGRESS, SUBMITTED]
        startedAt: { type: string, format: date-time }
        submittedAt: { type: string, format: date-time, nullable: true }
        results:
          type: array
          items:
            type: object
            required: [questionId, number, isCorrect]
            properties:
              questionId: { type: string }
              number: { type: number }
              isCorrect: { type: boolean }

    TestAttemptCreateRequest:
      type: object
      required: [subjectId]
      properties:
        subjectId: { type: string }

    TestAttemptSubmitRequest:
      type: object
      required: [results]
      properties:
        results:
          type: array
          items:
            type: object
            required: [questionId, number, isCorrect]
            properties:
              questionId: { type: string }
              number: { type: number }
              isCorrect: { type: boolean }

