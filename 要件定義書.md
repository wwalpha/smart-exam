# 学習教材・復習テスト管理システム 要件定義書（ドラフト v1.1）

## 0. 目的
- SAPIX / 四谷大塚の教材（問題・解答・答案）を一元管理する
- 問題番号・漢字単位で正誤・履歴を蓄積する
- 不正解のみを自動で再テスト化し、復習効率を最大化する
- 問題番号は教材差・表記差を吸収し、階層構造として統一管理する

## 1. 対象教材
### 1.1 SAPIX
- 採点済み答案用紙（画像 / PDF）
- 問題用紙（画像 / PDF）
- 解答（画像 / PDF）

### 1.2 四谷大塚
- 問題用紙（画像 / PDF）
- 解答（画像 / PDF）

## 2. 用語定義
- 教材セット：
  同一テスト回に属する「問題用紙・解答・（SAPIXの場合）答案」の集合
- 問題番号（Question Identifier）：
  教材内の設問を一意に識別する階層番号（例：1-1-1, 1-2-A）
- 正規化問題番号（canonicalKey）：
  表記ゆれを吸収したDB登録用の統一表現

## 3. 問題番号の統一ルール（最重要）

### 3.1 基本方針
- 問題番号は階層構造として管理する
- 表示用表記とDB保存用表記を分離する
- DBでは正規化された canonicalKey のみをキーとして使用する

### 3.2 問題番号の構造定義
問題番号は最大4階層までを許容する

  <大問>-<中問>-<小問>-<枝番>

例：
  1
  1-1
  1-1-1
  1-2-A
  2-3-2-B

### 3.3 各階層のルール
- 第1階層（大問）：数字（1,2,3…）
- 第2階層（中問）：数字（1,2,3…）
- 第3階層（小問）：数字または英大文字（1,2,A,B）
- 第4階層（枝番）：数字または英大文字
- 英字は必ず大文字
- 記号区切りは「-（ハイフン）」で統一

### 3.4 表記ゆれの正規化ルール（DB登録時）
以下は同一問題番号として扱う

  1(1)(1)
  １−１−１
  1－1－1
  1_1_1
  → 正規化後: 1-1-1

  1-2-a
  1-2-A
  → 正規化後: 1-2-A

正規化処理内容：
- 全角 → 半角
- 記号（( ) ／ － _ .）→ -
- 英字 → 大文字
- 連続ハイフンは1つにまとめる

### 3.5 内部データ構造（例）
- displayLabel: "1(2)ア"
- canonicalKey: "1-2-A"
- level1: 1
- level2: 2
- level3: "A"
- level4: null

## 4. 機能要件

### 4.1 教材管理
- 教材セットの登録・編集・削除
- 属性：
  - 教材種別（SAPIX / 四谷）
  - 科目（算数 / 国語 / 理科 / 社会）
  - 実施日
  - 回・テスト名
  - 任意メモ
- ファイル管理：
  - PDF / JPG / PNG
  - ページ単位プレビュー

### 4.2 問題番号の自動生成
- SAPIX：
  - 入力：採点済み答案
  - 出力：回答された問題番号候補一覧
  - 自動生成＋人手修正必須
- 四谷大塚：
  - 入力：解答用紙
  - 出力：解答に記載された問題番号候補一覧
  - パターン抽出＋人手修正必須

### 4.3 問題管理・学習履歴
- 問題マスタ：
  - 教材セットID
  - canonicalKey
  - 表示用問題番号
  - 科目
  - 分野タグ（任意）
- 学習履歴：
  - 問題ID
  - 実施日
  - 結果（正解 / 不正解 / 未判定）
  - メモ
  - 複数回履歴を保持

### 4.4 復習テスト生成（算数・理科・社会）
- 条件指定：
  - 科目
  - 不正解のみ
  - 期間（直近N日 / 全期間）
  - 出題数
- 出力：
  - 復習テスト（問題リスト）
  - 元教材ファイルへのリンク

### 4.5 漢字管理（国語・社会）
- 漢字マスタ：
  - 漢字
  - 読み
  - 意味（任意）
  - 科目（国語 / 社会）
  - 出典（任意）
- 漢字履歴：
  - 実施日
  - 正解 / 不正解
  - メモ

### 4.6 漢字復習テスト生成
- 不正解漢字のみ抽出
- 科目別（国語 / 社会）
- 出題数指定
- 実施履歴を保存

## 5. 非機能要件
- ファイルはユーザー単位でアクセス制御
- 問題番号抽出は非同期処理
- 操作ログ（登録・確定・テスト生成）を保持
- DB・ファイルのバックアップ必須

## 6. 主要リスクと対策
- 問題番号抽出の誤認識：
  完全自動化せず、候補提示＋手動確定を必須化
- 問題番号の表記崩壊：
  canonicalKey を唯一のDBキーとして使用

## 7. 実装フェーズ
- Phase 1：
  教材管理、手動問題番号登録、正誤管理、復習テスト生成
- Phase 2：
  問題番号自動生成（候補＋確定）
- Phase 3：
  ページジャンプ、分野別分析、CSV一括登録
