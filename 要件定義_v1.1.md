# 学習教材・復習テスト管理システム 要件定義書（ドラフト v1.1）

## 0. 目的
- SAPIX / 四谷大塚の教材（問題・解答・答案）を一元管理する
- 問題番号・漢字単位で正誤・履歴を蓄積する
- 不正解のみを自動で再テスト化し、復習効率を最大化する
- 問題番号は教材差・表記差を吸収し、階層構造として統一管理する

## 1. 対象教材
### 1.1 SAPIX
- 採点済み答案用紙（画像 / PDF）
- 問題用紙（画像 / PDF）
- 解答（画像 / PDF）

### 1.2 四谷大塚
- 問題用紙（画像 / PDF）
- 解答（画像 / PDF）

## 2. 用語定義
- 教材セット：
  同一テスト回に属する「問題用紙・解答・（SAPIXの場合）答案」の集合
- 問題番号（Question Identifier）：
  教材内の設問を一意に識別する階層番号（例：1-1-1, 1-2-A）
- 正規化問題番号（canonicalKey）：
  表記ゆれを吸収したDB登録用の統一表現

## 3. 問題番号の統一ルール（最重要）

### 3.1 基本方針
- 問題番号は階層構造として管理する
- 表示用表記とDB保存用表記を分離する
- DBでは正規化された canonicalKey のみをキーとして使用する

### 3.2 問題番号の構造定義
問題番号は最大4階層までを許容する

  <大問>-<中問>-<小問>-<枝番>

例：
  1
  1-1
  1-1-1
  1-2-A
  2-3-2-B

### 3.3 各階層のルール
- 第1階層（大問）：数字（1,2,3…）
- 第2階層（中問）：数字（1,2,3…）
- 第3階層（小問）：数字または英大文字（1,2,A,B）
- 第4階層（枝番）：数字または英大文字
- 英字は必ず大文字
- 記号区切りは「-（ハイフン）」で統一

### 3.4 表記ゆれの正規化ルール（DB登録時）
以下は同一問題番号として扱う

  1(1)(1)
  １−１−１
  1－1－1
  1_1_1
  → 正規化後: 1-1-1

  1-2-a
  1-2-A
  → 正規化後: 1-2-A

正規化処理内容：
- 全角 → 半角
- 記号（( ) ／ － _ .）→ -
- 英字 → 大文字
- 連続ハイフンは1つにまとめる

### 3.5 内部データ構造（例）
- displayLabel: "1(2)ア"
- canonicalKey: "1-2-A"
- level1: 1
- level2: 2
- level3: "A"
- level4: null

## 4. 機能要件

### 4.1 教材管理
- 教材セットの登録・編集・削除
- 属性：
  - 教材種別（SAPIX / 四谷）
  - 科目（算数 / 国語 / 理科 / 社会）
  - 実施日
  - 回・テスト名
  - 任意メモ
- ファイル管理：
  - PDF / JPG / PNG
  - ページ単位プレビュー

### 4.2 問題番号の自動生成
- SAPIX：
  - 入力：採点済み答案
  - 出力：回答された問題番号候補一覧
  - 自動生成＋人手修正必須
- 四谷大塚：
  - 入力：解答用紙
  - 出力：解答に記載された問題番号候補一覧
  - パターン抽出＋人手修正必須

### 4.3 問題管理・学習履歴
- 問題マスタ：
  - 教材セットID
  - canonicalKey
  - 表示用問題番号
  - 科目
  - 分野タグ（任意）
- 学習履歴：
  - 問題ID
  - 実施日
  - 結果（正解 / 不正解 / 未判定）
  - メモ
  - 複数回履歴を保持

### 4.4 復習テスト生成（算数・理科・社会）
- 条件指定：
  - 科目
  - 不正解のみ
  - 期間（直近N日 / 全期間）
  - 出題数
- 出力：
  - 復習テスト（問題リスト）
  - 元教材ファイルへのリンク

### 4.5 漢字管理（国語・社会）
- 漢字マスタ：
  - 漢字
  - 読み
  - 意味（任意）
  - 科目（国語 / 社会）
  - 出典（任意）
- 漢字履歴：
  - 実施日
  - 正解 / 不正解
  - メモ

### 4.6 漢字復習テスト生成
- 不正解漢字のみ抽出
- 科目別（国語 / 社会）
- 出題数指定
- 実施履歴を保存

## 5. 非機能要件
- ファイルはユーザー単位でアクセス制御
- 問題番号抽出は非同期処理
- 操作ログ（登録・確定・テスト生成）を保持
- DB・ファイルのバックアップ必須

## 6. 主要リスクと対策
- 問題番号抽出の誤認識：
  完全自動化せず、候補提示＋手動確定を必須化
- 問題番号の表記崩壊：
  canonicalKey を唯一のDBキーとして使用

## 7. 実装フェーズ
- Phase 1：
  教材管理、手動問題番号登録、正誤管理、復習テスト生成
- Phase 2：
  問題番号自動生成（候補＋確定）
- Phase 3：
  ページジャンプ、分野別分析、CSV一括登録
## 8. 追加要件（テスト管理・状態管理・復習間隔）

### 8.1 復習テストIDと再利用制御

- 復習テストは生成ごとに一意な TestID を持つ
- TestID は不変とし、削除されない限り履歴として保持する
- 復習テストに含まれた問題・漢字は、そのテストが「未完了」の間は
  他の復習テスト生成時に再利用できない
- テスト完了条件：
  - テスト内の全問題（または全漢字）が「実施済み」状態になること
- テスト完了後は、当該問題・漢字は次回以降のテスト生成対象に戻る

### 8.2 漢字の復習間隔ルール（固定ロジック）

漢字は以下の復習スケジュールに従って再出題対象とする。

- 初回登録：
  - 登録日から 7日後 に再出題対象
- 正解 1 回：
  - 最終正解日から 30日後 に再出題対象
- 連続正解 2 回：
  - 最終正解日から 90日後 に再出題対象
- 不正解の場合：
  - 即時（または翌日）再出題対象とする

※ 連続正解回数は「直近の連続正解数」で管理し、不正解が入った時点でリセットされる。

### 8.3 初回登録問題の正誤登録UI

- 初回登録された問題（教材取り込み時点）は、状態を「未実施」とする
- ユーザーは画面上で、問題番号ごとに以下を登録できる：
  - 実施日
  - 状態（未実施 / 正解 / 不正解）
- 正誤登録は以下の単位で可能とする：
  - 問題単位（canonicalKey 単位）
  - 一括入力（複数問題をまとめて設定）
- 状態変更は履歴として保持する（上書きではなく履歴追加）

### 8.4 問題・漢字の状態管理（State）

問題および漢字は、以下 3 状態を持つ。

- 未実施：
  - まだ解答・確認が行われていない状態
- 正解：
  - 正しく解答できた状態
- 不正解：
  - 誤答、または未達成と判断された状態

状態は以下の原則で扱う。

- 最新の状態が「現在状態」となる
- 過去の状態履歴はすべて保持する
- 復習テスト生成時は、原則「不正解」および
  復習間隔条件を満たした「正解」問題・漢字を対象とする
- 「未実施」は復習テスト対象には含めない（初回テストを除く）

### 8.5 データ構造への影響（要点）

- ReviewTest
  - testId
  - createdAt
  - status（IN_PROGRESS / COMPLETED）
- ReviewTestItem
  - testId
  - targetType（QUESTION / KANJI）
  - targetId
- Attempt / KanjiAttempt
  - state（UNATTEMPTED / CORRECT / INCORRECT）
  - attemptDate
  - streakCount（漢字のみ使用）
## 9. 追加要件（テスト運用・排他制御・可視化・復習スケジュール）

### 9.1 テストのライフサイクル管理（削除含む）

- 復習テスト（ReviewTest）は生成ごとに一意な TestID を持つ
- 復習テストの状態（status）は以下を持つ：
  - IN_PROGRESS：実施中（問題/漢字がロックされうる）
  - COMPLETED：完了
  - PAUSED：一時停止（ロックは維持）
  - CANCELED：中止（ロックは解除）
- 復習テストはユーザーが削除できる
  - 削除時は、そのテストに紐づくロックはすべて解除され、対象（問題/漢字）は再利用可能になる
  - 削除しても「教材ファイル」自体は削除しない（9.8参照）
  - 削除したテストはDB上は物理削除または論理削除のいずれでもよいが、いずれの場合も
    「ロック解除」「再利用可能化」は必ず実行される

### 9.2 テスト作成条件（科目・問題数）

- テスト作成時に、少なくとも以下を指定できる：
  - 科目（算数 / 国語 / 理科 / 社会）
  - 出題数（問題数または漢字数）
- 生成対象は、ロックされていない問題/漢字かつ、スケジュール条件を満たすもの
- 対象不足の場合は、生成を失敗させるのではなく
  - 「不足数」「不足理由（ロック中、対象がない、対象外になっている）」を提示する

### 9.3 テスト実施結果の手動登録（正解/不正解）

- 生成したテストに対して、ユーザーが手動で正解/不正解を登録できる
- 登録対象は以下：
  - テスト内の各問題（canonicalKey単位）
  - テスト内の各漢字
- 登録項目：
  - state（未実施 / 正解 / 不正解）
  - 実施日（デフォルトは当日。任意変更可）
- 状態は履歴として保持し、最新の状態が現在状態となる（既存要件踏襲）

### 9.4 排他制御（ロック）と可視化

- 復習テスト生成時、採用された各対象（問題/漢字）をロックする
  - ロックは「対象ID（問題ID/漢字ID）→ TestID」の紐付けとして保持する
  - 1つの対象は同時に1つのテストにのみロックされる（多重ロック禁止）
- ロック可視化：
  - 問題/漢字の詳細画面および一覧で「ロック中」「ロックしているTestID」を表示できる
  - テスト側でも「ロックしている対象一覧」を表示できる

### 9.5 ロック解除条件

- ロックされた問題/漢字は、当該テストで state が「正解」または「不正解」として登録された時点でロック解除される
  - 「未実施」のままでは解除されない
- テストが CANCELED / 削除された場合は、テスト内の全ロックを強制解除する
-（任意）ロック期限を設ける場合は、期限切れ時に自動解除し、解除理由をログに残す

### 9.6 可視化（不正解率）

- 問題・漢字それぞれについて、不正解率（incorrect rate）を可視化する
  - 不正解率 = 不正解回数 /（正解回数 + 不正解回数）
  - 未実施は分母に含めない
- 可視化の単位：
  - 全体（全科目）
  - 科目別（算数/国語/理科/社会）
  -（任意）期間指定（直近30日、全期間など）
- 画面例：
  - 上位（不正解率が高い）問題/漢字ランキング
  - 推移（任意：時系列）

### 9.7 復習スケジュール（問題）

問題（Question）は以下の復習スケジュールに従って「テスト生成対象」になる。

- 不正解：最終不正解日から 30日後 に再出題対象
- 正解：最終正解日から 90日後 に再出題対象
- 連続正解：最終正解日から 90日後（※正解と同じだが、連続回数は別途管理する）
- 3連続正解した問題は、今後テスト生成対象にならない（永久除外）
  - 3連続正解の定義：直近3回のAttemptがすべて正解であること
  - 不正解が入った場合、連続正解回数は 0 にリセットされる

※「テスト生成対象にならない」問題も、教材・履歴・可視化からは参照可能（削除はしない）。

### 9.8 問題登録と初回テストの分離

- 問題登録（教材取り込み・問題番号確定）と、初回テスト生成は分離する
  - 教材取り込み時点では、問題は「登録のみ」行う
  - 初回テストはユーザーが明示的に生成する（自動では作らない）

### 9.9 教材ファイルの保持方針

- 教材ファイル（答案/問題/解答）は削除しない
  - テスト削除や履歴削除を行っても、教材ファイルは保持される
  -（任意）参照不可（アーカイブ）状態は設けてもよいが、物理削除はしない

### 9.10 復習スケジュール（漢字：永久除外条件の追加）

- 漢字は既存の復習スケジュール（初回7日後 / 正解1回30日後 / 連続正解2回90日後）を踏襲する
- 3連続正解した漢字は、今後テスト生成対象にならない（永久除外）
  - 3連続正解の定義：直近3回のKanjiAttemptがすべて正解であること
  - 不正解が入った場合、連続正解回数は 0 にリセットされる

## 10. 追加要件（運用方針確定・検索・インポート・ダッシュボード・PDF出力）

### 10.1 ロック解除方針の確定（自動解除なし）

- ロックは自動解除しない
- ロック解除は以下の場合のみ行われる：
  - 当該テスト内で、問題または漢字の state が「正解」または「不正解」として登録されたとき
  - テストが CANCELED または 削除されたとき
- ロックの手動解除機能は設けない
  - 例外対応が必要になった場合は、将来の機能追加で対応する

### 10.2 対象不足時のテスト生成ルール

- テスト作成時、指定した問題数／漢字数に満たない場合でも、
  条件を満たす既存分のみでテストを生成する
- 生成結果が件数未満であった場合の判断はシステムでは行わず、
  ユーザーが以下を運用で判断する：
  - そのまま実施する
  - テストを削除する
- システムは以下の情報を明示的に表示する：
  - 指定件数
  - 実際に生成された件数
  - 不足理由（対象が存在しない／ロック中／永久除外など）

### 10.3 教材セットのメタデータ強化と検索

- 教材セットに以下のメタデータを追加できる：
  - 科目（算数 / 国語 / 理科 / 社会）
  - 実施日
  - 回・テスト名
  - 単元名（任意）
  - 教室 / コース（任意）
  - 任意タグ（複数）
- 教材セット一覧では、以下で検索・絞り込みができる：
  - 科目
  - 実施日（期間）
  - 回・テスト名
  - 単元
  - タグ
- 教材ファイルは削除対象外とする（既存要件踏襲）

### 10.4 漢字の大量登録（インポート）

- 漢字はテキストファイル（.txt）による一括登録をサポートする
- フォーマット仕様：
  - 1行 = 1漢字
  - 区切り文字は「|」（パイプ）
  - 例：
    漢字|よみ|意味
    憲法|けんぽう|国の基本となる法律
- 必須項目：
  - 漢字
- 任意項目：
  - よみ
  - 意味
- インポート時：
  - 重複漢字はスキップまたは更新（挙動は事前に選択）
  - 初回状態は「未実施」とする

### 10.5 ダッシュボード機能

- ダッシュボードを提供する
- 表示内容（最低限）：
  - 本日実施予定のテスト数
  - ロック中の問題数・漢字数
  - テスト生成可能な在庫数（問題 / 漢字）
  - 不正解率が高い上位問題・漢字
- ダッシュボードは「今日何をやるか」「なぜ作れないか」が即座に分かる構成とする

### 10.6 漢字テストのPDF生成・印刷

- 漢字テストについて、以下2種類のPDFを生成できる：
  1. 問題用PDF（漢字または読みが表示される）
  2. 解答用PDF（空欄形式、または答え付き）
- PDF生成フロー：
  - テスト生成
  - PDFプレビュー表示
  - 印刷（ブラウザ印刷）
- PDFには以下を含める：
  - テストID
  - 作成日
  - 科目（国語 / 社会）
  - 出題数
- PDFは保存対象とせず、都度生成でよい（履歴には TestID を紐付ける）

## 11. 更新要件（生成優先順位・一括入力・インポート検証・編集UI・PDFテンプレ）

### 11.1 ロック可視化の扱い（更新）

- 排他制御（ロック）は内部的に保持するが、ユーザー向けの「ロック見える化（どのテストがロックしているかの表示）」は提供しない
- 対象不足理由の内訳表示（ロック中等の詳細表示）も不要とする
  - ただし「指定件数」と「生成件数」は必ず表示する（10.2踏襲）

### 11.2 テスト作成の対象選択順（最重要：固定ルール）

- テスト生成対象は「テストすべき日（dueDate）」を各対象（問題/漢字）に持たせる
- テスト作成時の選択順は、以下の優先度で降順（= dueDate が最も過去のものから）とする：
  1) dueDate が最も古い（今日から最も離れている＝遅延が大きい）対象を優先
  2) 同一 dueDate の場合は、最終実施日が古いものを優先（任意：同率ならID昇順など決定論で固定）
- 例（今日=1/8）：
  - dueDate=1/7（7日後対象）より、dueDate=1/6（30日後対象）のほうが「遅延が大きい」ため優先される
  - 最後の1問を選ぶ局面でも、dueDate が古い（1/6）が選ばれる

### 11.3 未実施をテスト生成対象に含める（更新）

- 問題・漢字ともに、state が「未実施」であってもテスト生成対象に含める
- 未実施の dueDate は以下の扱いとする：
  - 初回登録日（問題：登録日、漢字：登録日）を基準にスケジュール計算し、dueDate を設定する
- これにより「未実施が放置され在庫が枯れる」前提は置かない（放置検出・通知は不要）

### 11.4 テスト結果入力UI（入力高速化）

- テスト結果入力は手動登録を前提とし、以下の操作を提供する：
  - 「全問 正解」一括セット
  - 不正解の問題/漢字のみをチェックして「不正解」に変更できる（チェック式一括入力）
  -（任意）全問 未実施へ戻す／一括変更（ただし履歴は保持）

### 11.5 漢字インポートの検証レポート（.txt | 区切り）

- 漢字インポート実行後、検証レポートを表示する
- レポートに含める項目（最低限）：
  - 取込成功件数
  - 重複件数（スキップ/更新の内訳）
  - エラー件数
  - エラー行の詳細（行番号、内容、エラー理由：必須欠落、区切り数不正等）
- 取り込みは「プレビュー→確定」の2段階でもよい（任意）

### 11.6 メタデータ（タグではなく分類項目）

- タグ運用は行わない
- 代わりに以下の分類項目を正式メタデータとして扱う（教材セット／テストに保持）：
  - 科目
  - 学年
  - 教材名（例：週テスト、組分けテスト、練習問題 等）
  - 回・テスト名
  - 実施日
  -（任意）コース/クラス

### 11.7 バックアップ方針（更新）

- バックアップ機能は基本不要（提供しない）
-（任意）障害対応のための内部バックアップ/運用は実装側判断とし、ユーザー機能としては持たない

### 11.8 問題番号自動生成結果の編集（更新）

- 自動スキャン等で生成した問題番号候補は、確定前に手動修正できる
  - 表記修正（displayLabel）
  - canonicalKey の修正（正規化ルールに従う）
  - 候補の追加・削除
- 確定後に問題番号が誤りだった場合も、手動で修正できる（履歴整合は保つ）

### 11.9 問題登録時の過不足調整（更新）

- スキャン取り込みで問題登録した際、問題数が不足／過多の場合に備え、以下を提供する：
  - 問題の手動追加（canonicalKey を入力して追加）
  - 問題の手動削除（誤登録の削除）
- 追加/削除の操作ログ（誰がいつ何を）は保持する（監査目的）

### 11.10 漢字PDFのテンプレ設定

- 漢字テストPDF生成に対し、テンプレ設定を提供する
- 設定項目（最低限）：
  - 用紙サイズ（A4 など）
  - 余白（上下左右）
  - 1ページあたりの行数 / 列数
  - マス目サイズ（書き取り用）
  - フォントサイズ（問題文/見出し）
  - タイトル表示（ON/OFF）
  - ヘッダに出す項目（テストID、作成日、科目、教材名 等）
- 設定はユーザー単位で保存し、デフォルトを持てる
## 12. 追加要件（印刷・教材検索）

### 12.1 復習問題のプリント出力（問題本文は生成しない）

- 復習テスト（問題）について、印刷可能な「問題一覧プリント」を生成できる
- 本プリントは問題本文を含めず、以下の参照情報のみを出力する：
  - テストID
  - 作成日
  - 科目
  - 教材名（例：週テスト、組分けテスト、練習問題 等）
  - 対象となる問題番号一覧（displayLabel および canonicalKey）
  - 元の教材セット情報（教材セット名、実施日、回・テスト名）
- 出力形式：
  - PDFプレビュー → 印刷（ブラウザ印刷）
- 目的：
  - 生成した問題番号を手元の教材（紙/PDF）で解くための“指示書”として使う

### 12.2 問題番号から既存教材を検索できる（教材本文は生成しない）

- 生成された復習テスト（問題）に含まれる各問題番号（canonicalKey）から、
  元になった教材を検索・特定できる機能を提供する
- 検索要件：
  - 入力：科目、問題番号（displayLabel または canonicalKey）
  - 出力：該当する教材セット候補の一覧
    - 教材種別（SAPIX / 四谷）
    - 教材名（週テスト等）
    - 実施日
    - 回・テスト名
    - その教材内の該当問題番号（displayLabel/canonicalKey）
- 復習テスト画面からの導線：
  - 各問題行に「教材を探す」アクションを提供し、該当教材セット一覧へ遷移できる
- 制約：
  - 問題本文（画像切り出し、OCR本文）は生成しない
  - ページ番号・位置情報は保持しない（既存方針踏襲）
## 13. 追加要件（教材メタデータの保持とテスト表示への反映）

### 13.1 教材登録時のメタデータ入力（必須/任意）

- 教材セット登録時に、以下のメタデータを入力・保存できる
- 必須項目：
  - 教材名（例：週テスト、組分けテスト、練習問題 等）
  - 実施日
  - 科目（算数 / 国語 / 理科 / 社会）
- 任意項目：
  - 学年
  - 回・テスト名（例：第3回、No.12、など）
  - 教材種別（SAPIX / 四谷）
  - コース/クラス（任意）
  - メモ
  - 追加キーワード（検索用の“タグ相当”）：複数登録可
    - ※自由タグ運用は行わない前提だが、検索・識別のためのキーワード欄として提供する

### 13.2 テスト作成・表示時に関連情報を表示する

- 復習テスト生成後、テスト詳細画面および印刷物（問題一覧プリント）に、
  各出題項目（問題/漢字）に紐づく「元教材セットのメタデータ」を表示する
- 表示内容（最低限）：
  - 教材名
  - 実施日
  - 回・テスト名（あれば）
  - 学年（あれば）
  - 教材種別（SAPIX/四谷）
- 出題項目の表示単位：
  - 問題：各問題番号行に「元教材情報」を併記
  - 漢字：漢字の出典（教材名/単元等、登録されている範囲）を併記

### 13.3 検索への反映

- 教材セット検索・絞り込みは、上記メタデータおよび追加キーワードで可能とする
- 復習テストからの「教材を探す」機能（12.2）は、
  問題番号だけでなく教材メタデータ（教材名、実施日、回など）でも候補を絞り込める
